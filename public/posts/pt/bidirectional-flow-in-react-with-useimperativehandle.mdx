---
title: Fluxo bidirecional no React com useImperativeHandle
description: Expondo uma fun√ß√£o de um componente child para o componente owner no React.
slug: bidirectional-flow-in-react-with-useimperativehandle
image: https://res.cloudinary.com/ddwnioveu/image/upload/v1707422678/large_joshua_sortino_71v_Ab1_FXB_6g_unsplash_46a1453603.jpg
alternativeText: A ic√¥nica Ponte Golden Gate envolta em neblina, criando uma cena m√≠stica e atmosf√©rica.
publishedAt: 2022-04-25
updatedAt: 2022-04-25
category: c√≥digo
author: Maur√≠cio Witter
keywords: react, nextjs, useImperativeHandle, useRef, forwardRef, lifting state up, fluxo unidirecional, fluxo bidirecional, context api, gerenciador de estado global
---

### Introdu√ß√£o

Ol√° üëã

Hoje vamos falar de fluxos unidirecional e bidirecional no Nextjs. Por padr√£o, no React, os dados fluem de uma maneira: do *owner* para o *child*, ou seja, no fluxo unidirecional, mas por vezes precisamos acessar determinada fun√ß√£o ou realizar uma mudan√ßa de estado em um componente *child* pelo componente *owner*, isto √©, de forma bidirecional, expondo um dado do componente inferior para o superior.

Para resolver isso, podemos elevar o estado (*Lifting State Up*) de um componente *child* para um componente *owner* que ir√° conter a l√≥gica do componente *child*. Outra forma √© utilizar a *Context API* ou outro gerenciador de estado global para compartilhamento de estado.  Mas, tamb√©m podemos expor uma fun√ß√£o ou estado para o componente *owner* por meio do *hook* `useImperativeHandle` e o *hook* `useRef` passando a refer√™ncia da propriedade para o componente *owner*. Vamos ver como isso funciona.

Conforme a documenta√ß√£o do React diz sobre o *hook* `useImperativeHandle`:

<Cite>
O *hook* `useImperativeHandle` personaliza o valor da inst√¢ncia que est√° exposta aos componentes *owner* ao usar `ref`. Como sempre, na maioria dos casos, seria bom evitar um c√≥digo imperativo usando refs.
</Cite>

E sobre o *hook* `useRef`:

<Cite>
`useRef` retorna um objeto `ref` mut√°vel, no qual a propriedade `current` √© inicializada para o argumento passado (`initialValue`). O objeto retornado persistir√° durante todo o ciclo de vida do componente.
</Cite>

Ou seja, o *hook* `useRef` cria um objeto mut√°vel que recebe um valor inicial no qual podemos mudar durante o ciclo de vida do componente, j√° o *hook*  `useImperativeHandle` vai nos ajudar a expor nossa propriedade para o componente superior de forma imperativa utilizando essa refer√™ncia.

### Vamos ao exemplo pr√°tico

Vamos come√ßar criando um *app* com o *framework* *Nextjs*. Rode no seu terminal os comandos abaixo para criar o projeto, em seguida entre no diret√≥rio e execute a aplica√ß√£o.

```shell
# crie o projeto
yarn create next-app --typescript

# entre no diret√≥rio criado
cd my-app

# compila e executa o projeto em http://localhost:3000
yarn dev
```

Projeto criado! Agora, vamos at√© o `index.tsx` em `/pages/index.tsx` e vamos remover o c√≥digo desnecess√°rio, deixe como no exemplo abaixo.

```tsx
import type { NextPage } from 'next'

const Home: NextPage = () => {
  return (
    <div> </div>
  )
}

export default Home
```

Vamos criar nosso componente `Modal`. Crie um diret√≥rio `components` na raiz do projeto e dentro dele um diret√≥rio `modal` e crie um arquivo `index.tsx`. Dentro do componente modal adicione uma `label` e um `input` com a l√≥gica de abrir o modal quando o estado for verdadeiro (*Short Circuit Evaluation*).

```tsx
// components/modal/index.tsx
import { useState } from "react";

const Modal: React.FC = () => {
  const [isModalOpen, setIsModalOpen] = useState(false);

  return (
    <>
    {isModalOpen && (
      <div className="modal">
        <label htmlFor="nome">Qual o seu nome ?</label>
        <input name="nome" />
      </div>
    )}
  </>
)};

export default Modal;
```

Vamos importar o `Modal` no componente `Home` e adicionar um bot√£o logo abaixo que vai disparar um evento ao receber um `click`. Esse evento precisa mudar o estado do modal para `true` para que seja exibido em tela. Logo, precisamos referenciar a fun√ß√£o que troca o estado do modal para o componente `Home`.

```tsx
import Modal from '../components/modal'
import type { NextPage } from 'next'

const Home: NextPage = () => {
  return (
    <main>
      <Modal />
      <button onClick={() => {}} className="open-modal-button">
        Open Modal
      </button>
  </main>
)}

export default Home
```

Antes vamos adicionar um estilo ao modal. Crie um arquivo de estilo `styles/modal.css`, esse estilo ir√° posicionar o modal sobre os outros elementos, centralizar seus componentes e adicionar uma largura e altura. Voc√™ pode copiar o CSS nesse [link](https://github.com/rwietter/blog-posts/blob/main/my-app/styles/modal.css).

No estilo `global.css` adicione o c√≥digo abaixo para centralizar o conte√∫do.

```css
/* styles/global.css */
main {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
```

Agora basta importar o arquivo `modal.css`em `pages/_app.tsx`. Dessa forma o estilo j√° ser√° aplicado ao nosso componente `Modal`.

```tsx
// pages/_app.tsx
import '../styles/globals.css';
import '../styles/modal.css';
```

Agora precisamos fazer o fluxo inverso, vamos referenciar a fun√ß√£o que vai alterar o estado para que o componente *owner* possa acessar. No modal precisamos receber a refer√™ncia que ser√° criada no componente *owner*, essa refer√™ncia √© obtida como segundo par√¢metro, tamb√©m vamos adicionar o **tipo** aos nossos par√¢metros com *generic types*.  Tamb√©m, vamos expor a fun√ß√£o `handleOpenModal` com o *hook* `useImperativeHandle`, como primeiro argumento ele recebe a refer√™ncia criada no *owner*, como segundo argumento uma *callback* que ir√° retornar um objeto com nossa fun√ß√£o que queremos acessar pela refer√™ncia criada no *owner*. Por fim, vamos exportar o componente como argumento da fun√ß√£o `forwardRef`, essa fun√ß√£o ir√° encaminhar a refer√™ncia ao componente *owner*.

```tsx
import {
  forwardRef,
  ForwardRefRenderFunction,
  ReactNode,
  useImperativeHandle,
  useState,
} from "react";

interface ModalProps {
  children?: ReactNode;
}

const Modal: ForwardRefRenderFunction<ModalRef, ModalProps> = (props, ref) => {
  const [isModalOpen, setIsModalOpen] = useState(false);

  const handleOpenModal = () => setIsModalOpen((state) => !state);

  useImperativeHandle(ref, () => ({
    handleOpenModal,
  }));

  // ...
  return (
    <></>
  )
}

export default forwardRef(Modal);
```

Agora, no componente `Home`, precisamos criar a `ref` e repassar para o componente modal.  Utilizamos o *hook* `useRef` para criar uma `ref` e passamos como *generic type* a interface `ModalRef` que espec√≠fica a fun√ß√£o que iremos referenciar. Exporte essa interface e importe no componente Modal, pois precisamos adicionar o *type* que recebemos como atributo do componente.

```tsx
export interface ModalRef {
  handleOpenModal: () => void;
}

const Home: NextPage = () => {
  const modalRef = useRef<ModalRef>(null);

  return (
    <>
      <Modal ref={modalRef} />
      <button onClick={() => {}}>Open Modal</button>
    </>
  )
}

export default Home;
```

Ainda no componente `Home`, s√≥ precisamos criar uma fun√ß√£o que ir√° receber a refer√™ncia da fun√ß√£o do `Modal` e repassar para a propriedade `onClick`. Feito isso, j√° iremos ter o modal funcional.

```tsx
const Home: NextPage = () => {
  const modalRef = useRef<ModalRef>(null);
  const handleOpenModal = () => modalRef.current?.handleOpenModal();

  return (
    <>
      <Modal ref={modalRef} />
      <button onClick={handleOpenModal}>Open Modal</button>
    </>
  )
}
```

Para finalizar, vamos adicionar um bot√£o de `close` no modal para fechar quando estiver aberto.

```tsx
return (
  <>
  {isModalOpen && (
      <div className="modal">
      <label htmlFor="nome">Qual o seu nome ?</label>
      <input name="nome" />
      <button onClick={handleOpenModal}>Close</button>
      </div>
    )}
  </>
);
```

### Conclus√£o

Essa √© uma forma simples de alterar um estado quando n√£o podemos ou n√£o queremos criar a l√≥gica de uma funcionalidade em um componente que n√£o precisa saber dessa funcionalidade ou n√£o queremos utilizar um gerenciador de estado.  N√£o √© muito comum, nem recomend√°vel utilizar c√≥digo imperativo, mas quando necess√°rio pode ser muito √∫til :)

At√© mais ‚öõ üëã

---

### Refer√™ncias

* [Hook useImperativeHandle](https://pt-br.reactjs.org/docs/hooks-reference.html#useimperativehandle)
* [Hook useRef](https://pt-br.reactjs.org/docs/hooks-reference.html#useref)
* [ForwardRef](https://pt-br.reactjs.org/docs/react-api.html#reactforwardref)
* [Reposit√≥rio do projeto](https://github.com/rwietter/blog-posts/tree/main/my-app)
